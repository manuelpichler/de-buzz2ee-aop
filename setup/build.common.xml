<?xml version="1.0" encoding="UTF-8"?>
<project name="buzz2ee-commons" basedir=".">

    <!--
        Some common settings for all buzz2ee sub projects.
    -->
    <property name="builddir" value="${basedir}/build" />

    <target name="dist" depends="build,tag" description="Default distribution build: Buzz2EE commons" />

    <target name="clean">
        <delete dir="${builddir}" includeemptydirs="true" />
    </target>

    <target name="update">
        <exec dir="${basedir}" executable="svn">
            <arg line="up" />
        </exec>
    </target>

    <target name="prepare" depends="clean,update">
        <mkdir dir="${builddir}/logs" />
        <mkdir dir="${builddir}/coverage" />
    </target>

    <target name="test" depends="prepare,lint,unittest" />

    <target name="lint">
        <apply executable="php" failonerror="true">
            <arg value="-l" />
            <fileset dir="${basedir}/source">
                <include name="**/*.php" />
            </fileset>
        </apply>
    </target>

    <target name="unittest">
        <exec dir="${basedir}/test"
              failonerror="true"
              executable="phpunit">
            <arg line="--coverage-html   ${basedir}/build/coverage" />
            <arg line="--coverage-clover ${basedir}/build/logs/clover.xml" />
            <arg line="--log-junit       ${basedir}/build/logs/junit.xml" />
            <arg line="AllTests.php" />
        </exec>
    </target>

    <target name="tag" depends="init">
        <!--
        <exec dir="${basedir}"
              executable="svn">
            <arg line="copy" />
            <arg line="." />
            <arg line="${repository}/tags/${ant.project.name}/${build.year}-kw${build.week}-qa-rev${revision}" />
        </exec>
        -->
        <echo message="svn copy . ${repository}/tags/${ant.project.name}/${build.year}-kw${build.week}-qa-rev${revision}" />
    </target>

    <target name="init">
        <exec executable="svn" dir="${basedir}" output="${builddir}/~svn-info.xml">
            <arg line="info" />
            <arg line="--xml" />
        </exec>

        <xmlproperty file="${builddir}/~svn-info.xml"
                     keepRoot="true"
                     collapseAttributes="true" />

        <property name="repository" value="${info.entry.repository.root}" />
        <property name="revision" value="${info.entry.commit.revision}" />

        <tstamp>
            <format property="build.year" pattern="yyyy" />
            <format property="build.week" pattern="w" />
        </tstamp>
    </target>

</project>